<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="voltar()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Painel Administrativo</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="carregarChecklists()">
        <ion-icon slot="icon-only" name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" color="light">
  <ion-header collapse="condense">
    <ion-toolbar color="primary">
      <ion-title size="large">Admin</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="recarregar($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="content-container">
    <!-- Seleção de Tipo de Checklist -->
    <ion-card class="tipo-checklist-card">
      <ion-card-content>
        <ion-segment [(ngModel)]="tipoChecklistSelecionado" (ionChange)="mudarTipoChecklist(tipoChecklistSelecionado)"
          mode="md">
          <ion-segment-button value="simples">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <ion-label>Checklist Simples</ion-label>
          </ion-segment-button>
          <ion-segment-button value="completo">
            <ion-icon name="clipboard-outline"></ion-icon>
            <ion-label>Checklist Completo</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

    <!-- Botão de Acesso ao Checklist Completo (Criar Novo) -->
    <ion-card color="success" *ngIf="tipoChecklistSelecionado === 'completo'">
      <ion-card-content>
        <ion-button expand="block" fill="solid" color="light" routerLink="/checklist-completo">
          <ion-icon slot="start" name="add-circle"></ion-icon>
          Criar Novo Checklist Completo
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Segmentos (Abas) -->
    <ion-segment [(ngModel)]="abaSelecionada" (ionChange)="mudarAba(abaSelecionada)">
      <ion-segment-button value="historico">
        <ion-label>Histórico</ion-label>
        <ion-icon name="list"></ion-icon>
      </ion-segment-button>
      <ion-segment-button value="anomalias">
        <ion-label>Anomalias</ion-label>
        <ion-icon name="warning"></ion-icon>
      </ion-segment-button>
      <ion-segment-button value="metricas">
        <ion-label>Métricas</ion-label>
        <ion-icon name="analytics"></ion-icon>
      </ion-segment-button>
      <ion-segment-button value="configuracao">
        <ion-label>Itens por Veículo</ion-label>
        <ion-icon name="car-sport"></ion-icon>
      </ion-segment-button>
      <ion-segment-button value="pneus">
        <ion-label>Pneus</ion-label>
        <ion-icon name="ellipse-outline"></ion-icon>
      </ion-segment-button>
    </ion-segment>

    <!-- ========================================= -->
    <!-- ABA: HISTÓRICO -->
    <!-- ========================================= -->
    <div *ngIf="abaSelecionada === 'historico'">
      <!-- Estatísticas -->
      <div class="stats-container animate-in-left">
        <ion-card class="stat-card">
          <ion-card-content>
            <h2>{{ checklistsHoje }}</h2>
            <p>Hoje</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card">
          <ion-card-content>
            <h2>{{ checklistsSemana }}</h2>
            <p>Semana</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card">
          <ion-card-content>
            <h2>{{ totalChecklists }}</h2>
            <p>Total</p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Filtros -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Filtros</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="filtros-container">
            <!-- Por Placa -->
            <div class="filtro-box">
              <span class="filtro-titulo">Por Placa</span>
              <ion-searchbar placeholder="Buscar placa..." [(ngModel)]="filtroPlaca" (ionInput)="buscarPorPlaca($event)"
                debounce="500"></ion-searchbar>
            </div>

            <!-- Por Data -->
            <div class="filtro-box">
              <span class="filtro-titulo">Por Data</span>
              <div class="data-inputs">
                <input type="date" [(ngModel)]="filtroDataInicio" (change)="aplicarFiltros()" placeholder="Data Inicial">
                <input type="date" [(ngModel)]="filtroDataFim" (change)="aplicarFiltros()" placeholder="Data Final">
              </div>
            </div>

            <!-- Por Local -->
            <div class="filtro-box">
              <span class="filtro-titulo">Por Local</span>
              <ion-searchbar placeholder="Buscar local..." [(ngModel)]="filtroLocal" (ionInput)="buscarPorLocal($event)"
                debounce="500"></ion-searchbar>
            </div>
          </div>

          <ion-button expand="block" fill="outline" color="medium" (click)="limparFiltros()" class="clear-filters-btn">
            <ion-icon slot="start" name="close-circle"></ion-icon>
            Limpar Filtros
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Loading -->
      <div *ngIf="carregando" class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Carregando checklists...</p>
      </div>

      <!-- Erro -->
      <ion-card *ngIf="erro && !carregando" color="danger">
        <ion-card-content>
          <ion-icon name="alert-circle"></ion-icon>
          {{ erro }}
        </ion-card-content>
      </ion-card>

      <!-- Resultados - Checklist Simples -->
      <ion-card *ngIf="!carregando && !erro && tipoChecklistSelecionado === 'simples'">
        <ion-card-header>
          <ion-card-title>
            Checklists Simples ({{ checklistsFiltrados.length }})
          </ion-card-title>
        </ion-card-header>
      </ion-card>

      <!-- Resultados - Checklist Completo -->
      <ion-card *ngIf="!carregando && !erro && tipoChecklistSelecionado === 'completo'">
        <ion-card-header>
          <ion-card-title>
            Checklists Completos ({{ checklistsCompletosFiltrados.length }})
          </ion-card-title>
        </ion-card-header>
      </ion-card>

      <!-- Lista vazia - Simples -->
      <div *ngIf="!carregando && !erro && tipoChecklistSelecionado === 'simples' && checklistsFiltrados.length === 0"
        class="empty-state animate-in">
        <ion-icon name="document-text-outline"></ion-icon>
        <h3>Nenhum checklist simples encontrado</h3>
        <p>Ajuste os filtros ou verifique a conexão com o servidor.</p>
      </div>

      <!-- Lista vazia - Completo -->
      <div
        *ngIf="!carregando && !erro && tipoChecklistSelecionado === 'completo' && checklistsCompletosFiltrados.length === 0"
        class="empty-state animate-in">
        <ion-icon name="document-text-outline"></ion-icon>
        <h3>Nenhum checklist completo encontrado</h3>
        <p>Ajuste os filtros ou verifique a conexão com o servidor.</p>
      </div>

      <!-- Lista de Checklists Simples -->
      <ion-list class="animate-in-left"
        *ngIf="!carregando && tipoChecklistSelecionado === 'simples' && checklistsFiltrados.length > 0">
        <ion-item-sliding *ngFor="let checklist of checklistsFiltrados">
          <ion-item button (click)="verDetalhes(checklist)">
            <div class="checklist-row">
              <div class="col-icone">
                <ion-icon name="car-sport" color="primary"></ion-icon>
              </div>
              <div class="col-placa">{{ checklist.placa }}</div>
              <div class="col-local">{{ checklist.local || '-' }}</div>
              <div class="col-inspetor">{{ checklist.usuario_nome || '-' }}</div>
              <div class="col-data">{{ formatarData(checklist.data_realizacao) }}</div>
            </div>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="verDetalhes(checklist)">
              <ion-icon slot="icon-only" name="eye"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>

      <!-- Lista de Checklists Completos -->
      <ion-list class="animate-in-right"
        *ngIf="!carregando && tipoChecklistSelecionado === 'completo' && checklistsCompletosFiltrados.length > 0">
        <ion-item-sliding *ngFor="let checklist of checklistsCompletosFiltrados">
          <ion-item button (click)="verDetalhesCompleto(checklist)">
            <div class="checklist-row">
              <div class="col-icone">
                <ion-icon name="clipboard" color="success"></ion-icon>
              </div>
              <div class="col-placa">{{ checklist.placa }}</div>
              <div class="col-local">{{ checklist.local || '-' }}</div>
              <div class="col-inspetor">{{ checklist.usuario_nome || '-' }}</div>
              <div class="col-data">{{ formatarData(checklist.data_realizacao) }}</div>
            </div>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="success" (click)="verDetalhesCompleto(checklist)">
              <ion-icon slot="icon-only" name="eye"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>
    </div>

    <!-- ========================================= -->
    <!-- ABA: ANOMALIAS -->
    <!-- ========================================= -->
    <div *ngIf="abaSelecionada === 'anomalias'">
      <ion-card color="danger">
        <ion-card-content>
          <ion-icon name="warning"></ion-icon>
          Veículos com problemas detectados nos checklists
        </ion-card-content>
      </ion-card>

      <!-- Segmento para alternar entre ativas e finalizadas -->
      <ion-segment [(ngModel)]="tipoAnomalias" (ionChange)="mudarTipoAnomalia()" style="margin-bottom: 20px;">
        <ion-segment-button value="ativas">
          <ion-label>Ativas</ion-label>
          <ion-icon name="alert-circle"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="finalizadas">
          <ion-label>Finalizadas</ion-label>
          <ion-icon name="checkmark-circle"></ion-icon>
        </ion-segment-button>
      </ion-segment>

      <!-- Busca por Placa -->
      <ion-searchbar
        placeholder="Buscar por placa..."
        [(ngModel)]="filtroPlacaAnomalia"
        (ionInput)="filtrarAnomalias()"
        debounce="300">
      </ion-searchbar>

      <!-- Loading -->
      <div *ngIf="carregandoAnomalias" class="loading-container">
        <ion-spinner name="crescent" color="danger"></ion-spinner>
        <p>Carregando anomalias...</p>
      </div>

      <!-- Erro -->
      <ion-card *ngIf="erroAnomalias && !carregandoAnomalias" color="danger">
        <ion-card-content>
          <ion-icon name="alert-circle"></ion-icon>
          {{ erroAnomalias }}
        </ion-card-content>
      </ion-card>

      <!-- Lista vazia -->
      <div *ngIf="!carregandoAnomalias && !erroAnomalias && anomaliasFiltradas.length === 0" class="empty-state animate-in">
        <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
        <h3>Nenhuma anomalia encontrada</h3>
        <p>{{ filtroPlacaAnomalia ? 'Nenhum resultado para esta busca' : 'Todos os veículos estão em bom estado!' }}</p>
      </div>

      <!-- Lista de Anomalias por Placa -->
      <div *ngIf="!carregandoAnomalias && anomaliasFiltradas.length > 0">
        <ion-card *ngFor="let veiculo of anomaliasFiltradas" class="anomalia-card">
          <ion-card-header [style.background]="'linear-gradient(135deg, #eb445a 0%, #c1365d 100%)'">
            <ion-card-title style="color: white; display: flex; align-items: center; justify-content: space-between;">
              <span>
                <ion-icon name="car" style="margin-right: 8px;"></ion-icon>
                {{ veiculo.placa }}
              </span>
              <ion-badge color="light">
                {{ veiculo.total_problemas }} problema{{ veiculo.total_problemas > 1 ? 's' : '' }}
              </ion-badge>
            </ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <!-- Resumo -->
            <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Total de problemas:</strong></span>
                <span>{{ veiculo.total_problemas }}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Inspeções com problema:</strong></span>
                <span>{{ veiculo.total_inspecoes_com_problema }}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span><strong>Última inspeção:</strong></span>
                <span>{{ formatarData(veiculo.data_ultima_inspecao) }}</span>
              </div>
            </div>

            <!-- Lista de Problemas -->
            <ion-button expand="block" fill="outline" color="danger" (click)="toggleDetalhesAnomalia(veiculo.placa)">
              <ion-icon name="{{ detalhesAnomaliaExpandido[veiculo.placa] ? 'chevron-up' : 'chevron-down' }}"
                slot="start"></ion-icon>
              {{ detalhesAnomaliaExpandido[veiculo.placa] ? 'Ocultar' : 'Ver' }} Detalhes dos Problemas
            </ion-button>

            <ion-list *ngIf="detalhesAnomaliaExpandido[veiculo.placa]">
              <ion-item *ngFor="let anomalia of veiculo.anomalias" lines="full">
                <ion-icon name="alert-circle" slot="start" color="danger"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3><strong>{{ anomalia.item }}</strong></h3>
                  <p>
                    <span *ngIf="anomalia.statuses && anomalia.statuses.length > 1">
                      <ion-badge *ngFor="let st of anomalia.statuses" [color]="getCorStatus(st)"
                        style="margin-right: 4px;">{{ st }}</ion-badge>
                    </span>
                    <ion-badge *ngIf="!anomalia.statuses || anomalia.statuses.length === 1"
                      [color]="getCorStatus(anomalia.status)">{{ anomalia.status }}</ion-badge>
                    <span style="margin-left: 8px;">{{ formatarCategoria(anomalia.categoria) }}</span>
                  </p>
                  <p style="font-size: 0.85em; color: var(--ion-color-medium); margin-top: 4px;">
                    <ion-icon name="calendar-outline" style="font-size: 0.9em;"></ion-icon>
                    {{ formatarData(anomalia.data_realizacao) }}
                    <span *ngIf="anomalia.total_ocorrencias && anomalia.total_ocorrencias > 1"
                      style="margin-left: 4px;">
                      <strong>({{ anomalia.total_ocorrencias }} ocorrências)</strong>
                    </span>
                    <span *ngIf="anomalia.inspecoes_ids && anomalia.inspecoes_ids.length > 1" style="margin-left: 4px;">
                      - {{ anomalia.inspecoes_ids.length }} inspeções
                    </span>
                  </p>
                  <p *ngIf="anomalia.usuarios && anomalia.usuarios.length > 0"
                    style="font-size: 0.85em; margin-top: 4px;">
                    <ion-icon name="people-outline"></ion-icon>
                    <span style="font-weight: 500;">{{ formatarUsuarios(anomalia.usuarios) }}</span>
                  </p>

                  <!-- Botões de Aprovação (apenas para ativas) -->
                  <div *ngIf="tipoAnomalias === 'ativas'"
                    style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <!-- Pendente: mostra botões Sim/Não -->
                    <div *ngIf="!anomalia.status_anomalia || anomalia.status_anomalia === 'pendente'"
                      style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                      <ion-button expand="block" color="success" (click)="aprovarAnomalia(veiculo.placa, anomalia)">
                        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                        Aprovar
                      </ion-button>
                      <ion-button expand="block" color="danger" (click)="reprovarAnomalia(veiculo.placa, anomalia)">
                        <ion-icon name="close-circle" slot="start"></ion-icon>
                        Reprovar
                      </ion-button>
                    </div>

                    <!-- Aprovado: mostra botão Finalizar -->
                    <div *ngIf="anomalia.status_anomalia === 'aprovado'" style="width: 100%;">
                      <ion-badge color="success" style="margin-bottom: 8px;">Aprovado</ion-badge>
                      <ion-button size="small" expand="block" color="warning"
                        (click)="finalizarAnomalia(veiculo.placa, anomalia)">
                        <ion-icon name="checkmark-done" slot="start"></ion-icon>
                        Finalizar
                      </ion-button>
                    </div>
                  </div>

                  <!-- Informação de finalização -->
                  <div *ngIf="tipoAnomalias === 'finalizadas' && anomalia.data_finalizacao" style="margin-top: 8px;">
                    <ion-badge color="medium">Finalizado em {{ formatarData(anomalia.data_finalizacao) }}</ion-badge>
                  </div>

                  <!-- Informações de aprovação (aparece tanto em ativas quanto finalizadas) -->
                  <div *ngIf="anomalia.status_anomalia === 'aprovado' || anomalia.status_anomalia === 'finalizado'"
                    style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; font-size: 0.85em; color: #000;">
                    <div *ngIf="anomalia.data_aprovacao" style="margin-bottom: 4px; color: #000;">
                      <ion-icon name="checkmark-circle" color="success"
                        style="font-size: 14px; vertical-align: middle;"></ion-icon>
                      <strong style="color: #000;">Aprovado em:</strong> {{ formatarData(anomalia.data_aprovacao) }}
                    </div>
                    <div *ngIf="anomalia.usuario_aprovador_nome" style="margin-bottom: 4px; color: #000;">
                      <ion-icon name="person" color="primary"
                        style="font-size: 14px; vertical-align: middle;"></ion-icon>
                      <strong style="color: #000;">Aprovado por:</strong> {{ anomalia.usuario_aprovador_nome }}
                    </div>
                    <div *ngIf="anomalia.observacao" style="margin-top: 4px; color: #000;">
                      <ion-icon name="chatbox" color="medium"
                        style="font-size: 14px; vertical-align: middle;"></ion-icon>
                      <strong style="color: #000;">Observação:</strong> {{ anomalia.observacao }}
                    </div>
                  </div>
                </ion-label>
                <ion-button slot="end" fill="clear" *ngIf="anomalia.foto" (click)="expandirFoto(anomalia.foto)">
                  <ion-icon name="image" color="primary"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- ========================================= -->
    <!-- ABA: MÉTRICAS -->
    <!-- ========================================= -->
    <div *ngIf="abaSelecionada === 'metricas'" class="aba-metricas">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="analytics" color="primary"></ion-icon>
            Dashboard de Métricas
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p style="color: #666;">Visão geral do sistema de inspeções</p>
        </ion-card-content>
      </ion-card>

      <!-- Resumo Geral -->
      <ion-row>
        <ion-col size="12" size-md="4">
          <ion-card color="primary">
            <ion-card-content style="text-align: center; padding: 16px;">
              <ion-icon name="people" style="font-size: 32px; color: white; margin-bottom: 8px;"></ion-icon>
              <h2 style="color: white; margin: 8px 0; font-size: 24px;">{{ metricas.totalUsuarios }}</h2>
              <p style="color: white; margin: 0; font-size: 0.9em;">Usuários</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="4">
          <ion-card color="success">
            <ion-card-content style="text-align: center; padding: 16px;">
              <ion-icon name="car-sport" style="font-size: 32px; color: white; margin-bottom: 8px;"></ion-icon>
              <h2 style="color: white; margin: 8px 0; font-size: 24px;">{{ metricas.totalVeiculos }}</h2>
              <p style="color: white; margin: 0; font-size: 0.9em;">Veículos</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="4">
          <ion-card color="tertiary">
            <ion-card-content style="text-align: center; padding: 16px;">
              <ion-icon name="location" style="font-size: 32px; color: white; margin-bottom: 8px;"></ion-icon>
              <h2 style="color: white; margin: 8px 0; font-size: 24px;">{{ metricas.totalLocais }}</h2>
              <p style="color: white; margin: 0; font-size: 0.9em;">Locais</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>

      <!-- Seletor de Gráficos -->
      <ion-segment [(ngModel)]="graficoSelecionado" (ionChange)="mudarGrafico($event)" mode="md"
        class="chart-segment">
        <ion-segment-button value="usuarios">
          <ion-label>Usuários</ion-label>
        </ion-segment-button>
        <ion-segment-button value="veiculos">
          <ion-label>Veículos</ion-label>
        </ion-segment-button>
        <ion-segment-button value="locais">
          <ion-label>Locais</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Busca -->
      <ion-searchbar placeholder="Filtrar dados do gráfico..." [(ngModel)]="termoBuscaGrafico"
        (ionInput)="buscarGrafico($event)" debounce="300" animated></ion-searchbar>

      <!-- Botão de Filtro para Locais (apenas quando gráfico de locais estiver selecionado) -->
      <ion-card *ngIf="graficoSelecionado === 'locais'" class="animate-in-up">
        <ion-card-content style="padding: 12px;">
          <ion-button 
            expand="block" 
            [color]="filtrarLocaisHoje ? 'success' : 'medium'"
            (click)="toggleFiltroLocaisHoje()"
            fill="outline">
            <ion-icon [name]="filtrarLocaisHoje ? 'checkmark-circle' : 'calendar-outline'" slot="start"></ion-icon>
            {{ filtrarLocaisHoje ? 'Mostrando apenas hoje' : 'Filtrar apenas hoje' }}
          </ion-button>
          <p *ngIf="filtrarLocaisHoje" style="margin-top: 8px; text-align: center; color: var(--ion-color-success); font-size: 0.9em;">
            <ion-icon name="information-circle-outline"></ion-icon>
            Exibindo apenas checklists realizados hoje
          </p>
        </ion-card-content>
      </ion-card>

      <!-- Container do Gráfico -->
      <ion-card class="chart-card animate-in-up">
        <ion-card-header>
          <ion-card-title class="ion-text-center">{{ getTituloGrafico() }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="chart-container"
            style="position: relative; height: 600px; width: 100%; display: flex; justify-content: center; align-items: center;">
            <canvas id="chartCanvas"></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Lista de Dados -->
      <ion-card class="animate-in-up" *ngIf="dadosGraficoFiltrados.length > 0">
        <ion-card-header>
          <ion-card-title>Detalhamento ({{ dadosGraficoFiltrados.length }})</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let item of dadosGraficoFiltrados">
              <ion-avatar slot="start" [style.background]="item.color"
                style="width: 24px; height: 24px; border-radius: 50%; margin-right: 16px;"></ion-avatar>
              <ion-label>
                <h2>{{ item.label }}</h2>
                <p>Quantidade: {{ item.value }}</p>
              </ion-label>
              <ion-badge slot="end" color="medium">{{ item.value }}</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Botão para Atualizar -->
      <ion-card>
        <ion-card-content style="text-align: center;">
          <ion-button expand="block" (click)="mudarAba('metricas')" [disabled]="carregandoMetricas">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Atualizar Gráficos
          </ion-button>
        </ion-card-content>
      </ion-card>


    </div>

    <!-- ========================================= -->
    <!-- ABA: ITENS POR TIPO DE VEÍCULO -->
    <!-- ========================================= -->
    <div *ngIf="abaSelecionada === 'configuracao'">
      <ion-card color="primary">
        <ion-card-content>
          <ion-icon name="car-sport"></ion-icon>
          Visualize os itens de inspeção configurados para cada tipo de veículo
        </ion-card-content>
      </ion-card>

      <!-- Botão para Campos da Inspeção Inicial (Global) -->
      <div class="campos-inspecao-hero" (click)="abrirModalCamposInspecaoInicial()">
        <div class="hero-background">
          <div class="hero-pattern"></div>
        </div>
        <div class="hero-content">
          <div class="hero-icon">
            <ion-icon name="document-text-outline"></ion-icon>
          </div>
          <div class="hero-text">
            <h3>Campos da Inspeção Inicial</h3>
            <p><ion-icon name="git-branch-outline"></ion-icon> Configuração base para todos os veículos</p>
          </div>
          <div class="hero-badge" *ngIf="camposInspecao.length > 0">
            <span>{{ camposInspecao.length }}</span>
          </div>
          <ion-icon name="chevron-forward-outline" class="hero-arrow"></ion-icon>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="carregandoTiposVeiculo" class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Carregando tipos de veículos...</p>
      </div>

      <!-- Cards de Tipos de Veículos -->
      <div *ngIf="!carregandoTiposVeiculo" class="tipos-veiculo-grid">
        <ion-card *ngFor="let tipo of tiposVeiculo"
                  [color]="tipoVeiculoSelecionadoConfig === tipo.id ? 'primary' : (tipo.ativo ? 'light' : '')"
                  (click)="tipo.ativo && selecionarTipoVeiculoConfig(tipo.id)"
                  class="tipo-veiculo-card"
                  [class.tipo-inativo]="!tipo.ativo"
                  [button]="tipo.ativo">
          <ion-card-content style="text-align: center; padding: 16px;">
            <ion-icon [name]="tipo.icone || 'car-outline'"
                      style="font-size: 48px; margin-bottom: 8px;"
                      [color]="tipoVeiculoSelecionadoConfig === tipo.id ? 'light' : (tipo.ativo ? 'primary' : 'medium')"></ion-icon>
            <h2 style="margin: 8px 0; font-weight: bold;"
                [style.color]="tipoVeiculoSelecionadoConfig === tipo.id ? 'white' : (tipo.ativo ? 'inherit' : 'var(--ion-color-medium)')">
              {{ tipo.nome }}
            </h2>
            <ion-badge [color]="tipo.ativo ? 'success' : 'medium'">
              {{ tipo.ativo ? 'Ativo' : 'Inativo' }}
            </ion-badge>
            <p style="margin-top: 8px; font-size: 0.9em;"
               [style.color]="tipoVeiculoSelecionadoConfig === tipo.id ? 'rgba(255,255,255,0.8)' : 'var(--ion-color-medium)'">
              <span *ngIf="tipo.ativo && itensPorTipoVeiculo[tipo.id]">
                {{ getItensHabilitadosTipo(tipo.id) }} / {{ getTotalItensTipo(tipo.id) }} itens
              </span>
              <span *ngIf="tipo.ativo && !itensPorTipoVeiculo[tipo.id]">
                Clique para ver itens
              </span>
            </p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Loading itens do tipo selecionado -->
      <div *ngIf="carregandoItensPorTipo" class="loading-container" style="margin-top: 20px;">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Carregando itens...</p>
      </div>

      <!-- Itens do Tipo de Veículo Selecionado -->
      <div *ngIf="tipoVeiculoSelecionadoConfig && itensPorTipoVeiculo[tipoVeiculoSelecionadoConfig] && !carregandoItensPorTipo">
        <ion-card color="tertiary" style="margin-top: 20px;">
          <ion-card-header>
            <ion-card-title>
              <ion-icon [name]="getIconeTipoVeiculoSelecionado()"></ion-icon>
              Itens de {{ getNomeTipoVeiculoSelecionado() }}
            </ion-card-title>
            <ion-card-subtitle>
              {{ getItensHabilitadosTipo(tipoVeiculoSelecionadoConfig) }} itens habilitados de {{ getTotalItensTipo(tipoVeiculoSelecionadoConfig) }} total
            </ion-card-subtitle>
          </ion-card-header>
        </ion-card>

        <!-- Itens agrupados por categoria -->
        <ng-container *ngFor="let categoria of categorias">
          <ion-card *ngIf="getItensPorCategoria(tipoVeiculoSelecionadoConfig!)[categoria.key] as itensCategoria">
            <ion-card-header *ngIf="itensCategoria.length > 0"
              [style.background]="'linear-gradient(135deg, ' + categoria.color + ' 0%, ' + categoria.color + 'dd 100%)'">
              <ion-card-title style="color: white;">
                <ion-icon [name]="categoria.icon"></ion-icon>
                {{ categoria.label }}
                <ion-badge color="light">
                  {{ itensCategoria.length }}
                </ion-badge>
              </ion-card-title>
            </ion-card-header>
            <ion-card-content *ngIf="itensCategoria.length > 0">
              <ion-list>
                <ng-container *ngFor="let item of itensCategoria">
                  <ion-item button (click)="abrirEdicaoItem(item)" [class.item-editando]="editandoItemId === item.id">
                    <ion-icon [name]="item.habilitado ? 'checkmark-circle' : 'close-circle'"
                              slot="start"
                              [color]="item.habilitado ? 'success' : 'danger'"></ion-icon>
                    <ion-label>
                      <h3>{{ item.nome_item }}</h3>
                      <p>
                        <ion-badge *ngIf="item.tipo_veiculo_id" color="tertiary" style="font-size: 0.7em; margin-right: 4px;">Específico</ion-badge>
                        <ion-badge [color]="item.tipo_resposta === 'conforme_nao_conforme' ? 'success' : item.tipo_resposta === 'texto' ? 'primary' : item.tipo_resposta === 'numero' ? 'tertiary' : item.tipo_resposta === 'apenas_foto' ? 'secondary' : 'warning'"
                                   style="font-size: 0.7em; margin-right: 4px;">
                          {{ item.tipo_resposta === 'conforme_nao_conforme' ? 'C/NC' : item.tipo_resposta === 'texto' ? 'Texto' : item.tipo_resposta === 'numero' ? 'Número' : item.tipo_resposta === 'lista_opcoes' ? 'Lista' : item.tipo_resposta === 'apenas_foto' ? 'Foto' : 'C/NC' }}
                        </ion-badge>
                        <ion-badge *ngIf="item.tem_foto" color="primary" style="font-size: 0.7em; margin-right: 4px;">Foto</ion-badge>
                        <ion-badge *ngIf="item.obrigatorio" color="warning" style="font-size: 0.7em;">Obrigatório</ion-badge>
                      </p>
                    </ion-label>
                    <ion-icon name="chevron-down-outline" slot="end" color="medium"
                              [style.transform]="editandoItemId === item.id ? 'rotate(180deg)' : 'none'"
                              style="transition: transform 0.2s; font-size: 18px;"></ion-icon>
                  </ion-item>

                  <!-- Formulário de edição inline -->
                  <div class="edit-item-inline" *ngIf="editandoItemId === item.id">
                    <div class="form-step">
                      <label class="form-step-label">Nome do item</label>
                      <ion-input [(ngModel)]="editItemNome"
                                 placeholder="Nome do item"
                                 fill="outline"
                                 class="form-input-dark">
                      </ion-input>
                    </div>

                    <div class="form-step">
                      <label class="form-step-label">Tipo de resposta</label>
                      <div class="form-step-chips">
                        <ion-chip [color]="editItemTipoResposta === 'conforme_nao_conforme' ? 'success' : 'medium'"
                                  [outline]="editItemTipoResposta !== 'conforme_nao_conforme'"
                                  (click)="editItemTipoResposta = 'conforme_nao_conforme'">
                          <ion-icon name="checkmark-done-outline"></ion-icon>
                          <ion-label>Conforme / Não conforme</ion-label>
                        </ion-chip>
                        <ion-chip [color]="editItemTipoResposta === 'texto' ? 'primary' : 'medium'"
                                  [outline]="editItemTipoResposta !== 'texto'"
                                  (click)="editItemTipoResposta = 'texto'">
                          <ion-icon name="text-outline"></ion-icon>
                          <ion-label>Texto</ion-label>
                        </ion-chip>
                        <ion-chip [color]="editItemTipoResposta === 'numero' ? 'tertiary' : 'medium'"
                                  [outline]="editItemTipoResposta !== 'numero'"
                                  (click)="editItemTipoResposta = 'numero'">
                          <ion-icon name="calculator-outline"></ion-icon>
                          <ion-label>Número</ion-label>
                        </ion-chip>
                        <ion-chip [color]="editItemTipoResposta === 'lista_opcoes' ? 'warning' : 'medium'"
                                  [outline]="editItemTipoResposta !== 'lista_opcoes'"
                                  (click)="editItemTipoResposta = 'lista_opcoes'">
                          <ion-icon name="list-outline"></ion-icon>
                          <ion-label>Lista de opções</ion-label>
                        </ion-chip>
                        <ion-chip [color]="editItemTipoResposta === 'apenas_foto' ? 'secondary' : 'medium'"
                                  [outline]="editItemTipoResposta !== 'apenas_foto'"
                                  (click)="editItemTipoResposta = 'apenas_foto'">
                          <ion-icon name="camera-outline"></ion-icon>
                          <ion-label>Apenas foto</ion-label>
                        </ion-chip>
                      </div>
                    </div>

                    <div class="form-step" *ngIf="editItemTipoResposta === 'lista_opcoes'">
                      <label class="form-step-label">Opções da lista</label>
                      <div class="form-opcoes-lista">
                        <div class="form-opcao-item" *ngFor="let opcao of editItemOpcoesResposta; let i = index">
                          <span>{{ opcao }}</span>
                          <ion-button fill="clear" color="danger" size="small" (click)="removerOpcaoRespostaEdit(i)">
                            <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                          </ion-button>
                        </div>
                        <div class="form-opcao-adicionar">
                          <ion-input [(ngModel)]="editItemNovaOpcao"
                                     placeholder="Digite uma opção"
                                     fill="outline"
                                     class="form-input-dark"
                                     (keyup.enter)="adicionarOpcaoRespostaEdit()">
                          </ion-input>
                          <ion-button fill="solid" color="primary" size="small" (click)="adicionarOpcaoRespostaEdit()" [disabled]="!editItemNovaOpcao.trim()">
                            <ion-icon name="add" slot="icon-only"></ion-icon>
                          </ion-button>
                        </div>
                      </div>
                    </div>

                    <div class="form-step">
                      <label class="form-step-label">Opções</label>
                      <div class="form-step-toggles">
                        <ion-item lines="none" class="form-toggle-item">
                          <ion-icon name="power-outline" slot="start" color="success"></ion-icon>
                          <ion-label>Habilitado</ion-label>
                          <ion-toggle [(ngModel)]="editItemHabilitado" slot="end" color="success"></ion-toggle>
                        </ion-item>
                        <ion-item lines="none" class="form-toggle-item" *ngIf="editItemTipoResposta !== 'apenas_foto'">
                          <ion-icon name="camera-outline" slot="start" color="primary"></ion-icon>
                          <ion-label>Tem foto</ion-label>
                          <ion-toggle [(ngModel)]="editItemTemFoto" slot="end" color="primary"></ion-toggle>
                        </ion-item>
                        <ion-item lines="none" class="form-toggle-item" *ngIf="editItemTipoResposta === 'conforme_nao_conforme'">
                          <ion-icon name="camera-outline" slot="start" color="tertiary"></ion-icon>
                          <ion-label>Foto quando não conforme</ion-label>
                          <ion-toggle [(ngModel)]="editItemFotoNaoConforme" slot="end" color="tertiary"></ion-toggle>
                        </ion-item>
                        <ion-item lines="none" class="form-toggle-item">
                          <ion-icon name="alert-circle-outline" slot="start" color="warning"></ion-icon>
                          <ion-label>Obrigatório</ion-label>
                          <ion-toggle [(ngModel)]="editItemObrigatorio" slot="end" color="warning"></ion-toggle>
                        </ion-item>
                      </div>
                    </div>

                    <div class="form-step-actions">
                      <ion-button fill="outline" color="medium" (click)="fecharEdicaoItem()">
                        Cancelar
                      </ion-button>
                      <ion-button color="primary" (click)="salvarEdicaoItem()" [disabled]="!editItemNome.trim()">
                        <ion-icon name="save-outline" slot="start"></ion-icon>
                        Salvar
                      </ion-button>
                    </div>
                  </div>
                </ng-container>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <!-- Mensagem se não houver itens -->
        <ion-card *ngIf="getTotalItensTipo(tipoVeiculoSelecionadoConfig) === 0" color="warning">
          <ion-card-content>
            <ion-icon name="alert-circle"></ion-icon>
            Nenhum item configurado para este tipo de veículo
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Mensagem para selecionar um tipo -->
      <ion-card *ngIf="!tipoVeiculoSelecionadoConfig && !carregandoTiposVeiculo" color="medium" style="margin-top: 20px;">
        <ion-card-content style="text-align: center;">
          <ion-icon name="hand-left-outline" style="font-size: 48px; margin-bottom: 16px;"></ion-icon>
          <h3>Selecione um tipo de veículo</h3>
          <p>Clique em um dos tipos acima para visualizar seus itens de inspeção</p>
        </ion-card-content>
      </ion-card>

      <!-- Botão Adicionar Novo Item -->
      <ion-button expand="block" color="success" style="margin-top: 20px;" (click)="mostrarFormNovoItem = !mostrarFormNovoItem" *ngIf="!mostrarFormNovoItem">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Adicionar Novo Item
      </ion-button>

      <!-- Formulário inline para novo item -->
      <ion-card *ngIf="mostrarFormNovoItem" class="form-novo-item-card" style="margin-top: 20px;">
        <ion-card-header>
          <ion-card-title style="display: flex; align-items: center; justify-content: space-between;">
            <span>
              <ion-icon name="add-circle-outline" style="margin-right: 8px;"></ion-icon>
              Novo Item
            </span>
            <ion-button fill="clear" color="medium" size="small" (click)="cancelarFormNovoItem()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <!-- Step 1: Tipo do item -->
          <div class="form-step">
            <label class="form-step-label">Tipo do item</label>
            <div class="form-step-options">
              <ion-button [fill]="novoItemTipo === 'geral' ? 'solid' : 'outline'" color="primary" size="small" (click)="novoItemTipo = 'geral'; novoItemTipoVeiculoId = null">
                <ion-icon name="globe-outline" slot="start"></ion-icon>
                Geral
              </ion-button>
              <ion-button [fill]="novoItemTipo === 'especifico' ? 'solid' : 'outline'" color="primary" size="small" (click)="novoItemTipo = 'especifico'">
                <ion-icon name="car-outline" slot="start"></ion-icon>
                Específico
              </ion-button>
            </div>
          </div>

          <!-- Step 2: Categoria -->
          <div class="form-step">
            <label class="form-step-label">Categoria</label>
            <div class="form-step-chips">
              <ion-chip *ngFor="let cat of categorias"
                        [color]="novoItemCategoria === cat.key ? 'primary' : 'medium'"
                        [outline]="novoItemCategoria !== cat.key"
                        (click)="novoItemCategoria = cat.key">
                <ion-icon [name]="cat.icon"></ion-icon>
                <ion-label>{{ cat.label }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Step 3: Tipo de veículo (se específico) -->
          <div class="form-step" *ngIf="novoItemTipo === 'especifico'">
            <label class="form-step-label">Tipo de Veículo</label>
            <div class="form-step-chips">
              <ion-chip *ngFor="let tipo of tiposVeiculo"
                        [color]="novoItemTipoVeiculoId === tipo.id ? 'tertiary' : 'medium'"
                        [outline]="novoItemTipoVeiculoId !== tipo.id"
                        (click)="novoItemTipoVeiculoId = tipo.id">
                <ion-icon [name]="tipo.icone || 'car-outline'"></ion-icon>
                <ion-label>{{ tipo.nome }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Step 3b: Tipos associados (se geral) -->
          <div class="form-step" *ngIf="novoItemTipo === 'geral'">
            <label class="form-step-label">Tipos de veículo associados</label>
            <div class="form-step-chips">
              <ion-chip *ngFor="let tipo of tiposVeiculo"
                        [color]="novoItemTiposAssociados.includes(tipo.id) ? 'tertiary' : 'medium'"
                        [outline]="!novoItemTiposAssociados.includes(tipo.id)"
                        (click)="toggleTipoAssociado(tipo.id)">
                <ion-icon [name]="tipo.icone || 'car-outline'"></ion-icon>
                <ion-label>{{ tipo.nome }}</ion-label>
                <ion-icon name="checkmark" *ngIf="novoItemTiposAssociados.includes(tipo.id)"></ion-icon>
              </ion-chip>
            </div>
          </div>

          <!-- Step 4: Nome do item -->
          <div class="form-step">
            <label class="form-step-label">Nome do item</label>
            <ion-input [(ngModel)]="novoItemNome"
                       placeholder="Ex: Verificar nível do óleo"
                       fill="outline"
                       class="form-input-dark">
            </ion-input>
          </div>

          <!-- Step 5: Tipo de resposta -->
          <div class="form-step">
            <label class="form-step-label">Tipo de resposta</label>
            <div class="form-step-chips">
              <ion-chip [color]="novoItemTipoResposta === 'conforme_nao_conforme' ? 'success' : 'medium'"
                        [outline]="novoItemTipoResposta !== 'conforme_nao_conforme'"
                        (click)="novoItemTipoResposta = 'conforme_nao_conforme'">
                <ion-icon name="checkmark-done-outline"></ion-icon>
                <ion-label>Conforme / Não conforme</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemTipoResposta === 'texto' ? 'primary' : 'medium'"
                        [outline]="novoItemTipoResposta !== 'texto'"
                        (click)="novoItemTipoResposta = 'texto'">
                <ion-icon name="text-outline"></ion-icon>
                <ion-label>Texto</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemTipoResposta === 'numero' ? 'tertiary' : 'medium'"
                        [outline]="novoItemTipoResposta !== 'numero'"
                        (click)="novoItemTipoResposta = 'numero'">
                <ion-icon name="calculator-outline"></ion-icon>
                <ion-label>Número</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemTipoResposta === 'lista_opcoes' ? 'warning' : 'medium'"
                        [outline]="novoItemTipoResposta !== 'lista_opcoes'"
                        (click)="novoItemTipoResposta = 'lista_opcoes'">
                <ion-icon name="list-outline"></ion-icon>
                <ion-label>Lista de opções</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemTipoResposta === 'apenas_foto' ? 'secondary' : 'medium'"
                        [outline]="novoItemTipoResposta !== 'apenas_foto'"
                        (click)="novoItemTipoResposta = 'apenas_foto'">
                <ion-icon name="camera-outline"></ion-icon>
                <ion-label>Apenas foto</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Step 5b: Opções da lista (se tipo = lista_opcoes) -->
          <div class="form-step" *ngIf="novoItemTipoResposta === 'lista_opcoes'">
            <label class="form-step-label">Opções da lista</label>
            <div class="form-opcoes-lista">
              <div class="form-opcao-item" *ngFor="let opcao of novoItemOpcoesResposta; let i = index">
                <span>{{ opcao }}</span>
                <ion-button fill="clear" color="danger" size="small" (click)="removerOpcaoResposta(i)">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              <div class="form-opcao-adicionar">
                <ion-input [(ngModel)]="novoItemNovaOpcao"
                           placeholder="Digite uma opção"
                           fill="outline"
                           class="form-input-dark"
                           (keyup.enter)="adicionarOpcaoResposta()">
                </ion-input>
                <ion-button fill="solid" color="primary" size="small" (click)="adicionarOpcaoResposta()" [disabled]="!novoItemNovaOpcao.trim()">
                  <ion-icon name="add" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Step 6: Opções -->
          <div class="form-step">
            <label class="form-step-label">Opções</label>
            <div class="form-step-toggles">
              <ion-item lines="none" class="form-toggle-item" *ngIf="novoItemTipoResposta !== 'apenas_foto'">
                <ion-icon name="camera-outline" slot="start" color="primary"></ion-icon>
                <ion-label>Tem foto</ion-label>
                <ion-toggle [(ngModel)]="novoItemTemFoto" slot="end" color="primary"></ion-toggle>
              </ion-item>
              <ion-item lines="none" class="form-toggle-item" *ngIf="novoItemTipoResposta === 'conforme_nao_conforme'">
                <ion-icon name="camera-outline" slot="start" color="tertiary"></ion-icon>
                <ion-label>Foto quando não conforme</ion-label>
                <ion-toggle [(ngModel)]="novoItemFotoNaoConforme" slot="end" color="tertiary"></ion-toggle>
              </ion-item>
              <ion-item lines="none" class="form-toggle-item">
                <ion-icon name="alert-circle-outline" slot="start" color="warning"></ion-icon>
                <ion-label>Obrigatório</ion-label>
                <ion-toggle [(ngModel)]="novoItemObrigatorio" slot="end" color="warning"></ion-toggle>
              </ion-item>
            </div>
          </div>

          <!-- Botões de ação -->
          <div class="form-step-actions">
            <ion-button fill="outline" color="medium" (click)="cancelarFormNovoItem()">
              Cancelar
            </ion-button>
            <ion-button color="success" (click)="salvarNovoItem()"
                        [disabled]="!novoItemNome || !novoItemCategoria || (novoItemTipo === 'especifico' && !novoItemTipoVeiculoId) || (novoItemTipo === 'geral' && novoItemTiposAssociados.length === 0)">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Adicionar Item
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

    </div>

    <!-- ========================================= -->
    <!-- ABA: PNEUS -->
    <!-- ========================================= -->
    <div *ngIf="abaSelecionada === 'pneus'">
      <ion-card color="primary">
        <ion-card-content>
          <ion-icon name="ellipse-outline"></ion-icon>
          Configure as posições e regras de inspeção de pneus para cada tipo de veículo
        </ion-card-content>
      </ion-card>

      <!-- Sub-abas: Posições / Regras -->
      <ion-segment [(ngModel)]="subAbaPneus" style="margin-bottom: 16px;">
        <ion-segment-button value="posicoes">
          <ion-icon name="navigate-outline"></ion-icon>
          <ion-label>Posições</ion-label>
        </ion-segment-button>
        <ion-segment-button value="regras">
          <ion-icon name="list-outline"></ion-icon>
          <ion-label>Regras de Inspeção</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Loading -->
      <div *ngIf="carregandoTiposVeiculo" class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Carregando tipos de veículos...</p>
      </div>

      <!-- Cards de Tipos de Veículos -->
      <div *ngIf="!carregandoTiposVeiculo" class="tipos-veiculo-grid">
        <ion-card *ngFor="let tipo of tiposVeiculo"
                  [color]="tipoVeiculoSelecionadoPneus === tipo.id ? 'primary' : (tipo.ativo ? 'light' : '')"
                  (click)="tipo.ativo && selecionarTipoVeiculoPneus(tipo.id)"
                  class="tipo-veiculo-card"
                  [class.tipo-inativo]="!tipo.ativo"
                  [button]="tipo.ativo">
          <ion-card-content style="text-align: center; padding: 16px;">
            <ion-icon [name]="tipo.icone || 'car-outline'"
                      style="font-size: 48px; margin-bottom: 8px;"
                      [color]="tipoVeiculoSelecionadoPneus === tipo.id ? 'light' : (tipo.ativo ? 'primary' : 'medium')"></ion-icon>
            <h2 style="margin: 8px 0; font-weight: bold;"
                [style.color]="tipoVeiculoSelecionadoPneus === tipo.id ? 'white' : (tipo.ativo ? 'inherit' : 'var(--ion-color-medium)')">
              {{ tipo.nome }}
            </h2>
            <ion-badge [color]="tipo.ativo ? 'success' : 'medium'">
              {{ tipo.ativo ? 'Ativo' : 'Inativo' }}
            </ion-badge>
            <p style="margin-top: 8px; font-size: 0.9em;"
               [style.color]="tipoVeiculoSelecionadoPneus === tipo.id ? 'rgba(255,255,255,0.8)' : 'var(--ion-color-medium)'">
              <span *ngIf="tipo.ativo && itensPneusPorTipo[tipo.id]">
                {{ getPneusHabilitadosTipo(tipo.id) }} / {{ getTotalPneusTipo(tipo.id) }} regras
              </span>
              <span *ngIf="tipo.ativo && !itensPneusPorTipo[tipo.id]">
                Clique para configurar
              </span>
            </p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- ===== SUB-ABA: POSIÇÕES ===== -->
      <div *ngIf="subAbaPneus === 'posicoes'">
        <!-- Loading posições -->
        <div *ngIf="carregandoPosicoesPneus" class="loading-container" style="margin-top: 20px;">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
          <p>Carregando posições...</p>
        </div>

        <!-- Lista de Posições do Tipo Selecionado -->
        <div *ngIf="tipoVeiculoSelecionadoPneus && posicoesPneusPorTipo[tipoVeiculoSelecionadoPneus] && !carregandoPosicoesPneus">
          <ion-card color="tertiary" style="margin-top: 20px;">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="navigate-outline"></ion-icon>
                Posições de {{ getNomeTipoVeiculoPneus() }}
              </ion-card-title>
              <ion-card-subtitle>
                {{ getPosicoesPneusHabilitadosTipo(tipoVeiculoSelecionadoPneus) }} habilitadas de {{ getTotalPosicoesPneusTipo(tipoVeiculoSelecionadoPneus) }} total
              </ion-card-subtitle>
            </ion-card-header>
          </ion-card>

          <ion-card *ngIf="getPosicoesPneus().length > 0">
            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let posicao of getPosicoesPneus()">
                  <ion-icon [name]="posicao.habilitado ? 'checkmark-circle' : 'close-circle'"
                            slot="start"
                            [color]="posicao.habilitado ? 'success' : 'danger'"></ion-icon>
                  <ion-label>
                    <h3>{{ posicao.nome }}</h3>
                    <p>Ordem: {{ posicao.ordem }}</p>
                  </ion-label>
                  <ion-toggle [checked]="posicao.habilitado"
                              (ionChange)="toggleHabilitadoPosicaoPneu(posicao)"
                              slot="end"
                              color="success"></ion-toggle>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>

          <ion-card *ngIf="getPosicoesPneus().length === 0" color="warning">
            <ion-card-content>
              <ion-icon name="alert-circle"></ion-icon>
              Nenhuma posição configurada para este tipo de veículo
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Mensagem para selecionar tipo -->
        <ion-card *ngIf="!tipoVeiculoSelecionadoPneus && !carregandoTiposVeiculo" color="medium" style="margin-top: 20px;">
          <ion-card-content style="text-align: center;">
            <ion-icon name="hand-left-outline" style="font-size: 48px; margin-bottom: 16px;"></ion-icon>
            <h3>Selecione um tipo de veículo</h3>
            <p>Clique em um dos tipos acima para visualizar as posições</p>
          </ion-card-content>
        </ion-card>

        <!-- Botão Adicionar Nova Posição -->
        <ion-button expand="block" color="success" style="margin-top: 20px;" (click)="mostrarFormNovaPosicaoPneu = !mostrarFormNovaPosicaoPneu" *ngIf="!mostrarFormNovaPosicaoPneu">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Adicionar Nova Posição
        </ion-button>

        <!-- Formulário nova posição -->
        <ion-card *ngIf="mostrarFormNovaPosicaoPneu" class="form-novo-item-card" style="margin-top: 20px;">
          <ion-card-header>
            <ion-card-title style="display: flex; align-items: center; justify-content: space-between;">
              <span>
                <ion-icon name="add-circle-outline" style="margin-right: 8px;"></ion-icon>
                Nova Posição de Pneu
              </span>
              <ion-button fill="clear" color="medium" size="small" (click)="cancelarFormNovaPosicaoPneu()">
                <ion-icon name="close" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <!-- Tipos de veículo associados -->
            <div class="form-step">
              <label class="form-step-label">Tipos de veículo associados</label>
              <div class="form-step-chips">
                <ion-chip *ngFor="let tipo of tiposVeiculo"
                          [color]="novaPosicaoPneuTiposAssociados.includes(tipo.id) ? 'tertiary' : 'medium'"
                          [outline]="!novaPosicaoPneuTiposAssociados.includes(tipo.id)"
                          (click)="toggleTipoAssociadoPosicaoPneu(tipo.id)">
                  <ion-icon [name]="tipo.icone || 'car-outline'"></ion-icon>
                  <ion-label>{{ tipo.nome }}</ion-label>
                  <ion-icon name="checkmark" *ngIf="novaPosicaoPneuTiposAssociados.includes(tipo.id)"></ion-icon>
                </ion-chip>
              </div>
            </div>

            <!-- Nome da posição -->
            <div class="form-step">
              <label class="form-step-label">Nome da posição</label>
              <ion-input [(ngModel)]="novaPosicaoPneuNome"
                         placeholder="Ex: Dianteiro Direito, Estepe, Traseiro Interno Esquerdo"
                         fill="outline"
                         class="form-input-dark">
              </ion-input>
            </div>

            <div class="form-step-actions">
              <ion-button fill="outline" color="medium" (click)="cancelarFormNovaPosicaoPneu()">
                Cancelar
              </ion-button>
              <ion-button color="success" (click)="salvarNovaPosicaoPneu()"
                          [disabled]="!novaPosicaoPneuNome.trim() || novaPosicaoPneuTiposAssociados.length === 0">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Adicionar Posição
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- ===== SUB-ABA: REGRAS DE INSPEÇÃO ===== -->
      <div *ngIf="subAbaPneus === 'regras'">
        <!-- Loading itens pneus -->
        <div *ngIf="carregandoItensPneus" class="loading-container" style="margin-top: 20px;">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
          <p>Carregando regras...</p>
        </div>

        <!-- Lista de Regras do Tipo Selecionado -->
        <div *ngIf="tipoVeiculoSelecionadoPneus && itensPneusPorTipo[tipoVeiculoSelecionadoPneus] && !carregandoItensPneus">
          <ion-card color="tertiary" style="margin-top: 20px;">
            <ion-card-header>
              <ion-card-title>
                <ion-icon [name]="getIconeTipoVeiculoPneus()"></ion-icon>
                Regras de Inspeção de {{ getNomeTipoVeiculoPneus() }}
              </ion-card-title>
              <ion-card-subtitle>
                {{ getPneusHabilitadosTipo(tipoVeiculoSelecionadoPneus) }} regras habilitadas de {{ getTotalPneusTipo(tipoVeiculoSelecionadoPneus) }} total
              </ion-card-subtitle>
          </ion-card-header>
        </ion-card>

        <ion-card *ngIf="getItensPneus().length > 0">
          <ion-card-header style="background: linear-gradient(135deg, #666 0%, #444 100%);">
            <ion-card-title style="color: white;">
              <ion-icon name="list-outline"></ion-icon>
              Regras de Inspeção
              <ion-badge color="light">{{ getItensPneus().length }}</ion-badge>
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ng-container *ngFor="let item of getItensPneus()">
                <ion-item button (click)="abrirEdicaoItem(item)" [class.item-editando]="editandoItemId === item.id">
                  <ion-icon [name]="item.habilitado ? 'checkmark-circle' : 'close-circle'"
                            slot="start"
                            [color]="item.habilitado ? 'success' : 'danger'"></ion-icon>
                  <ion-label>
                    <h3>{{ item.nome_item }}</h3>
                    <p>
                      <ion-badge *ngIf="item.tipo_veiculo_id" color="tertiary" style="font-size: 0.7em; margin-right: 4px;">Específico</ion-badge>
                      <ion-badge [color]="item.tipo_resposta === 'conforme_nao_conforme' ? 'success' : item.tipo_resposta === 'texto' ? 'primary' : item.tipo_resposta === 'numero' ? 'tertiary' : 'warning'"
                                 style="font-size: 0.7em; margin-right: 4px;">
                        {{ item.tipo_resposta === 'conforme_nao_conforme' ? 'C/NC' : item.tipo_resposta === 'texto' ? 'Texto' : item.tipo_resposta === 'numero' ? 'Número' : item.tipo_resposta === 'lista_opcoes' ? 'Lista' : 'C/NC' }}
                      </ion-badge>
                      <ion-badge *ngIf="item.tem_foto" color="primary" style="font-size: 0.7em; margin-right: 4px;">Foto</ion-badge>
                      <ion-badge *ngIf="item.obrigatorio" color="warning" style="font-size: 0.7em;">Obrigatório</ion-badge>
                    </p>
                  </ion-label>
                  <ion-icon name="chevron-down-outline" slot="end" color="medium"
                            [style.transform]="editandoItemId === item.id ? 'rotate(180deg)' : 'none'"
                            style="transition: transform 0.2s; font-size: 18px;"></ion-icon>
                </ion-item>

                <!-- Formulário de edição inline -->
                <div class="edit-item-inline" *ngIf="editandoItemId === item.id">
                  <div class="form-step">
                    <label class="form-step-label">Nome da regra</label>
                    <ion-input [(ngModel)]="editItemNome"
                               placeholder="Nome da regra de inspeção"
                               fill="outline"
                               class="form-input-dark">
                    </ion-input>
                  </div>

                  <div class="form-step">
                    <label class="form-step-label">Tipo de resposta</label>
                    <div class="form-step-chips">
                      <ion-chip [color]="editItemTipoResposta === 'conforme_nao_conforme' ? 'success' : 'medium'"
                                [outline]="editItemTipoResposta !== 'conforme_nao_conforme'"
                                (click)="editItemTipoResposta = 'conforme_nao_conforme'">
                        <ion-icon name="checkmark-done-outline"></ion-icon>
                        <ion-label>Conforme / Não conforme</ion-label>
                      </ion-chip>
                      <ion-chip [color]="editItemTipoResposta === 'texto' ? 'primary' : 'medium'"
                                [outline]="editItemTipoResposta !== 'texto'"
                                (click)="editItemTipoResposta = 'texto'">
                        <ion-icon name="text-outline"></ion-icon>
                        <ion-label>Texto</ion-label>
                      </ion-chip>
                      <ion-chip [color]="editItemTipoResposta === 'numero' ? 'tertiary' : 'medium'"
                                [outline]="editItemTipoResposta !== 'numero'"
                                (click)="editItemTipoResposta = 'numero'">
                        <ion-icon name="calculator-outline"></ion-icon>
                        <ion-label>Número</ion-label>
                      </ion-chip>
                      <ion-chip [color]="editItemTipoResposta === 'lista_opcoes' ? 'warning' : 'medium'"
                                [outline]="editItemTipoResposta !== 'lista_opcoes'"
                                (click)="editItemTipoResposta = 'lista_opcoes'">
                        <ion-icon name="list-outline"></ion-icon>
                        <ion-label>Lista de opções</ion-label>
                      </ion-chip>
                      <ion-chip [color]="editItemTipoResposta === 'apenas_foto' ? 'secondary' : 'medium'"
                                [outline]="editItemTipoResposta !== 'apenas_foto'"
                                (click)="editItemTipoResposta = 'apenas_foto'">
                        <ion-icon name="camera-outline"></ion-icon>
                        <ion-label>Apenas foto</ion-label>
                      </ion-chip>
                    </div>
                  </div>

                  <div class="form-step" *ngIf="editItemTipoResposta === 'lista_opcoes'">
                    <label class="form-step-label">Opções da lista</label>
                    <div class="form-opcoes-lista">
                      <div class="form-opcao-item" *ngFor="let opcao of editItemOpcoesResposta; let i = index">
                        <span>{{ opcao }}</span>
                        <ion-button fill="clear" color="danger" size="small" (click)="removerOpcaoRespostaEdit(i)">
                          <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                        </ion-button>
                      </div>
                      <div class="form-opcao-adicionar">
                        <ion-input [(ngModel)]="editItemNovaOpcao"
                                   placeholder="Digite uma opção"
                                   fill="outline"
                                   class="form-input-dark"
                                   (keyup.enter)="adicionarOpcaoRespostaEdit()">
                        </ion-input>
                        <ion-button fill="solid" color="primary" size="small" (click)="adicionarOpcaoRespostaEdit()" [disabled]="!editItemNovaOpcao.trim()">
                          <ion-icon name="add" slot="icon-only"></ion-icon>
                        </ion-button>
                      </div>
                    </div>
                  </div>

                  <div class="form-step">
                    <label class="form-step-label">Opções</label>
                    <div class="form-step-toggles">
                      <ion-item lines="none" class="form-toggle-item">
                        <ion-icon name="power-outline" slot="start" color="success"></ion-icon>
                        <ion-label>Habilitado</ion-label>
                        <ion-toggle [(ngModel)]="editItemHabilitado" slot="end" color="success"></ion-toggle>
                      </ion-item>
                      <ion-item lines="none" class="form-toggle-item" *ngIf="editItemTipoResposta !== 'apenas_foto'">
                        <ion-icon name="camera-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>Tem foto</ion-label>
                        <ion-toggle [(ngModel)]="editItemTemFoto" slot="end" color="primary"></ion-toggle>
                      </ion-item>
                      <ion-item lines="none" class="form-toggle-item" *ngIf="editItemTipoResposta === 'conforme_nao_conforme'">
                        <ion-icon name="camera-outline" slot="start" color="tertiary"></ion-icon>
                        <ion-label>Foto quando não conforme</ion-label>
                        <ion-toggle [(ngModel)]="editItemFotoNaoConforme" slot="end" color="tertiary"></ion-toggle>
                      </ion-item>
                      <ion-item lines="none" class="form-toggle-item">
                        <ion-icon name="alert-circle-outline" slot="start" color="warning"></ion-icon>
                        <ion-label>Obrigatório</ion-label>
                        <ion-toggle [(ngModel)]="editItemObrigatorio" slot="end" color="warning"></ion-toggle>
                      </ion-item>
                    </div>
                  </div>

                  <div class="form-step-actions">
                    <ion-button fill="outline" color="medium" (click)="fecharEdicaoItem()">
                      Cancelar
                    </ion-button>
                    <ion-button color="primary" (click)="salvarEdicaoItemPneu()" [disabled]="!editItemNome.trim()">
                      <ion-icon name="save-outline" slot="start"></ion-icon>
                      Salvar
                    </ion-button>
                  </div>
                </div>
              </ng-container>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Mensagem se não houver regras -->
        <ion-card *ngIf="getItensPneus().length === 0" color="warning">
          <ion-card-content>
            <ion-icon name="alert-circle"></ion-icon>
            Nenhuma regra de inspeção configurada para este tipo de veículo
          </ion-card-content>
        </ion-card>
        </div>
      </div>

      <!-- Mensagem para selecionar um tipo (sub-aba regras) -->
      <ion-card *ngIf="subAbaPneus === 'regras' && !tipoVeiculoSelecionadoPneus && !carregandoTiposVeiculo" color="medium" style="margin-top: 20px;">
        <ion-card-content style="text-align: center;">
          <ion-icon name="hand-left-outline" style="font-size: 48px; margin-bottom: 16px;"></ion-icon>
          <h3>Selecione um tipo de veículo</h3>
          <p>Clique em um dos tipos acima para visualizar as regras de inspeção</p>
        </ion-card-content>
      </ion-card>

      <!-- Botão Adicionar Nova Regra -->
      <ion-button expand="block" color="success" style="margin-top: 20px;" (click)="mostrarFormNovoItemPneu = !mostrarFormNovoItemPneu" *ngIf="subAbaPneus === 'regras' && !mostrarFormNovoItemPneu">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Adicionar Nova Regra
      </ion-button>

      <!-- Formulário inline para nova regra de inspeção -->
      <ion-card *ngIf="mostrarFormNovoItemPneu" class="form-novo-item-card" style="margin-top: 20px;">
        <ion-card-header>
          <ion-card-title style="display: flex; align-items: center; justify-content: space-between;">
            <span>
              <ion-icon name="add-circle-outline" style="margin-right: 8px;"></ion-icon>
              Nova Regra de Inspeção
            </span>
            <ion-button fill="clear" color="medium" size="small" (click)="cancelarFormNovoItemPneu()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <!-- Tipos de veículo associados -->
          <div class="form-step">
            <label class="form-step-label">Tipos de veículo associados</label>
            <div class="form-step-chips">
              <ion-chip *ngFor="let tipo of tiposVeiculo"
                        [color]="novoItemPneuTiposAssociados.includes(tipo.id) ? 'tertiary' : 'medium'"
                        [outline]="!novoItemPneuTiposAssociados.includes(tipo.id)"
                        (click)="toggleTipoAssociadoPneu(tipo.id)">
                <ion-icon [name]="tipo.icone || 'car-outline'"></ion-icon>
                <ion-label>{{ tipo.nome }}</ion-label>
                <ion-icon name="checkmark" *ngIf="novoItemPneuTiposAssociados.includes(tipo.id)"></ion-icon>
              </ion-chip>
            </div>
          </div>

          <!-- Nome da regra -->
          <div class="form-step">
            <label class="form-step-label">Nome da regra</label>
            <ion-input [(ngModel)]="novoItemPneuNome"
                       placeholder="Ex: Estado da Borracha, Profundidade do Sulco"
                       fill="outline"
                       class="form-input-dark">
            </ion-input>
          </div>

          <!-- Step 4: Tipo de resposta -->
          <div class="form-step">
            <label class="form-step-label">Tipo de resposta</label>
            <div class="form-step-chips">
              <ion-chip [color]="novoItemPneuTipoResposta === 'conforme_nao_conforme' ? 'success' : 'medium'"
                        [outline]="novoItemPneuTipoResposta !== 'conforme_nao_conforme'"
                        (click)="novoItemPneuTipoResposta = 'conforme_nao_conforme'">
                <ion-icon name="checkmark-done-outline"></ion-icon>
                <ion-label>Conforme / Não conforme</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemPneuTipoResposta === 'texto' ? 'primary' : 'medium'"
                        [outline]="novoItemPneuTipoResposta !== 'texto'"
                        (click)="novoItemPneuTipoResposta = 'texto'">
                <ion-icon name="text-outline"></ion-icon>
                <ion-label>Texto</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemPneuTipoResposta === 'numero' ? 'tertiary' : 'medium'"
                        [outline]="novoItemPneuTipoResposta !== 'numero'"
                        (click)="novoItemPneuTipoResposta = 'numero'">
                <ion-icon name="calculator-outline"></ion-icon>
                <ion-label>Número</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemPneuTipoResposta === 'lista_opcoes' ? 'warning' : 'medium'"
                        [outline]="novoItemPneuTipoResposta !== 'lista_opcoes'"
                        (click)="novoItemPneuTipoResposta = 'lista_opcoes'">
                <ion-icon name="list-outline"></ion-icon>
                <ion-label>Lista de opções</ion-label>
              </ion-chip>
              <ion-chip [color]="novoItemPneuTipoResposta === 'apenas_foto' ? 'secondary' : 'medium'"
                        [outline]="novoItemPneuTipoResposta !== 'apenas_foto'"
                        (click)="novoItemPneuTipoResposta = 'apenas_foto'">
                <ion-icon name="camera-outline"></ion-icon>
                <ion-label>Apenas foto</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Step 4b: Opções da lista (se tipo = lista_opcoes) -->
          <div class="form-step" *ngIf="novoItemPneuTipoResposta === 'lista_opcoes'">
            <label class="form-step-label">Opções da lista</label>
            <div class="form-opcoes-lista">
              <div class="form-opcao-item" *ngFor="let opcao of novoItemPneuOpcoesResposta; let i = index">
                <span>{{ opcao }}</span>
                <ion-button fill="clear" color="danger" size="small" (click)="removerOpcaoRespostaPneu(i)">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              <div class="form-opcao-adicionar">
                <ion-input [(ngModel)]="novoItemPneuNovaOpcao"
                           placeholder="Digite uma opção"
                           fill="outline"
                           class="form-input-dark"
                           (keyup.enter)="adicionarOpcaoRespostaPneu()">
                </ion-input>
                <ion-button fill="solid" color="primary" size="small" (click)="adicionarOpcaoRespostaPneu()" [disabled]="!novoItemPneuNovaOpcao.trim()">
                  <ion-icon name="add" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Step 5: Opções -->
          <div class="form-step">
            <label class="form-step-label">Opções</label>
            <div class="form-step-toggles">
              <ion-item lines="none" class="form-toggle-item" *ngIf="novoItemPneuTipoResposta !== 'apenas_foto'">
                <ion-icon name="camera-outline" slot="start" color="primary"></ion-icon>
                <ion-label>Tem foto</ion-label>
                <ion-toggle [(ngModel)]="novoItemPneuTemFoto" slot="end" color="primary"></ion-toggle>
              </ion-item>
              <ion-item lines="none" class="form-toggle-item">
                <ion-icon name="alert-circle-outline" slot="start" color="warning"></ion-icon>
                <ion-label>Obrigatório</ion-label>
                <ion-toggle [(ngModel)]="novoItemPneuObrigatorio" slot="end" color="warning"></ion-toggle>
              </ion-item>
            </div>
          </div>

          <!-- Botões de ação -->
          <div class="form-step-actions">
            <ion-button fill="outline" color="medium" (click)="cancelarFormNovoItemPneu()">
              Cancelar
            </ion-button>
            <ion-button color="success" (click)="salvarNovoItemPneu()"
                        [disabled]="!novoItemPneuNome || (novoItemPneuTipo === 'especifico' && !novoItemPneuTipoVeiculoId) || (novoItemPneuTipo === 'geral' && novoItemPneuTiposAssociados.length === 0)">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Adicionar Regra
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

    </div>

  </div>
</ion-content>

<!-- Modal de Detalhes -->
<ion-modal [isOpen]="mostrarModal" (didDismiss)="fecharModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Detalhes do Checklist</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content *ngIf="checklistDetalhado">
      <div class="detalhes-container">
        <!-- Informações Básicas -->
        <ion-card class="info-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="information-circle"></ion-icon>
              Informações do Veículo
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <ion-icon name="finger-print" color="medium"></ion-icon>
                <div class="info-content">
                  <span class="info-label">ID</span>
                  <span class="info-value">#{{ checklistDetalhado.id }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="car" color="primary"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Placa</span>
                  <span class="info-value">{{ checklistDetalhado.placa }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="location" color="danger"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Local</span>
                  <span class="info-value">{{ checklistDetalhado.local || 'Não informado' }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="speedometer" color="warning"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Quilometragem</span>
                  <span class="info-value">{{ checklistDetalhado.km_inicial }} km</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="water" color="tertiary"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Combustível</span>
                  <span class="info-value">{{ formatarNivelCombustivel(checklistDetalhado.nivel_combustivel) }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="calendar" color="success"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Data/Hora</span>
                  <span class="info-value">{{ formatarData(checklistDetalhado.data_realizacao) }}</span>
                </div>
              </div>

              <div class="info-item" *ngIf="checklistDetalhado.usuario">
                <ion-icon name="person" color="secondary"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Inspetor</span>
                  <span class="info-value">{{ checklistDetalhado.usuario.nome }}</span>
                </div>
              </div>
            </div>

            <div class="observacao-section" *ngIf="checklistDetalhado.observacao_painel">
              <ion-chip color="warning">
                <ion-icon name="chatbox-ellipses"></ion-icon>
                <ion-label>Observação do Painel</ion-label>
              </ion-chip>
              <p class="observacao-text">{{ checklistDetalhado.observacao_painel }}</p>
            </div>

            <div class="observacao-section" *ngIf="checklistDetalhado.observacao_adicional">
              <ion-chip color="tertiary">
                <ion-icon name="document-text-outline"></ion-icon>
                <ion-label>Observação Adicional</ion-label>
              </ion-chip>
              <p class="observacao-text">{{ checklistDetalhado.observacao_adicional }}</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Tempo de Telas -->
        <ion-card *ngIf="temposTelas && temposTelas.length > 0">
          <ion-card-header>
            <ion-card-title>Tempo de Telas</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="tempos-grid">
              <div class="tempo-item" *ngFor="let tempo of temposTelas">
                <ion-icon name="time-outline" color="primary"></ion-icon>
                <div class="tempo-content">
                  <span class="tempo-nome">{{ getNomeTela(tempo.tela) }}</span>
                  <span class="tempo-valor">{{ formatarTempo(tempo.tempo_segundos) }}</span>
                </div>
              </div>
            </div>
            <div class="tempo-total">
              <strong>Tempo Total:</strong> {{ getTotalTempo() }}
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Foto do Painel e Observação -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Painel do Veículo</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="foto-item" *ngIf="checklistDetalhado.fotos?.PAINEL">
              <h4>Foto do Painel</h4>
              <img [src]="checklistDetalhado.fotos.PAINEL" alt="Painel"
                (click)="expandirFoto(checklistDetalhado.fotos.PAINEL)" />
            </div>
            <ion-item *ngIf="checklistDetalhado.observacao_painel">
              <ion-label class="ion-text-wrap">
                <h3>Observações do Painel:</h3>
                <p>{{ checklistDetalhado.observacao_painel }}</p>
              </ion-label>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- Inspeção do Motor -->
        <ion-card *ngIf="checklistDetalhado.itens?.MOTOR && checklistDetalhado.itens.MOTOR.length > 0">
          <ion-card-header>
            <ion-card-title>Inspeção do Motor</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <div *ngFor="let item of checklistDetalhado.itens.MOTOR">
                <ion-item>
                  <ion-label>
                    <h3>{{ item.item }}</h3>
                    <p><ion-badge [color]="getCorStatus(item.status)">{{ item.status || 'N/A' }}</ion-badge></p>
                    <p *ngIf="item.descricao"><em>{{ item.descricao }}</em></p>
                  </ion-label>
                </ion-item>
                <div class="foto-item" *ngIf="item.foto">
                  <img [src]="item.foto" [alt]="item.item" (click)="expandirFoto(item.foto)" />
                </div>
              </div>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Inspeção Elétrica -->
        <ion-card *ngIf="checklistDetalhado.itens?.ELETRICO && checklistDetalhado.itens.ELETRICO.length > 0">
          <ion-card-header>
            <ion-card-title>Sistema Elétrico</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <div *ngFor="let item of checklistDetalhado.itens.ELETRICO">
                <ion-item>
                  <ion-label>
                    <h3>{{ item.item }}</h3>
                    <p><ion-badge [color]="getCorStatus(item.status)">{{ item.status || 'N/A' }}</ion-badge></p>
                    <p *ngIf="item.descricao"><em>{{ item.descricao }}</em></p>
                  </ion-label>
                </ion-item>
                <div class="foto-item" *ngIf="item.foto">
                  <img [src]="item.foto" [alt]="item.item" (click)="expandirFoto(item.foto)" />
                </div>
              </div>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Limpeza -->
        <ion-card *ngIf="checklistDetalhado.itens?.LIMPEZA && checklistDetalhado.itens.LIMPEZA.length > 0">
          <ion-card-header>
            <ion-card-title>Limpeza</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <div *ngFor="let item of checklistDetalhado.itens.LIMPEZA">
                <ion-item>
                  <ion-label>
                    <h3>{{ item.item }}</h3>
                    <p><ion-badge [color]="getCorStatus(item.status)">{{ item.status || 'N/A' }}</ion-badge></p>
                    <p *ngIf="item.descricao"><em>{{ item.descricao }}</em></p>
                  </ion-label>
                </ion-item>
                <div class="foto-item" *ngIf="item.foto">
                  <img [src]="item.foto" [alt]="item.item" (click)="expandirFoto(item.foto)" />
                </div>
              </div>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Ferramentas -->
        <ion-card *ngIf="checklistDetalhado.itens?.FERRAMENTA && checklistDetalhado.itens.FERRAMENTA.length > 0">
          <ion-card-header>
            <ion-card-title>Ferramentas e Equipamentos</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <div *ngFor="let item of checklistDetalhado.itens.FERRAMENTA">
                <ion-item>
                  <ion-label>
                    <h3>{{ item.item }}</h3>
                    <p><ion-badge [color]="item.status === 'contem' ? 'success' : 'danger'">{{ item.status === 'contem'
                        ? 'Contém' : 'Não Contém' }}</ion-badge></p>
                    <p *ngIf="item.descricao"><em>{{ item.descricao }}</em></p>
                  </ion-label>
                </ion-item>
                <div class="foto-item" *ngIf="item.foto">
                  <img [src]="item.foto" [alt]="item.item" (click)="expandirFoto(item.foto)" />
                </div>
              </div>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Fotos do Veículo -->
        <ion-card *ngIf="checklistDetalhado.fotos">
          <ion-card-header>
            <ion-card-title>Fotos do Veículo</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="foto-grid">
              <div class="foto-item" *ngIf="checklistDetalhado.fotos.FRONTAL">
                <h4>Foto Frontal</h4>
                <img [src]="checklistDetalhado.fotos.FRONTAL" alt="Frontal"
                  (click)="expandirFoto(checklistDetalhado.fotos.FRONTAL)" />
              </div>
              <div class="foto-item" *ngIf="checklistDetalhado.fotos.TRASEIRA">
                <h4>Foto Traseira</h4>
                <img [src]="checklistDetalhado.fotos.TRASEIRA" alt="Traseira"
                  (click)="expandirFoto(checklistDetalhado.fotos.TRASEIRA)" />
              </div>
              <div class="foto-item" *ngIf="checklistDetalhado.fotos.LATERAL_DIREITA">
                <h4>Foto Lateral Direita</h4>
                <img [src]="checklistDetalhado.fotos.LATERAL_DIREITA" alt="Lateral Direita"
                  (click)="expandirFoto(checklistDetalhado.fotos.LATERAL_DIREITA)" />
              </div>
              <div class="foto-item" *ngIf="checklistDetalhado.fotos.LATERAL_ESQUERDA">
                <h4>Foto Lateral Esquerda</h4>
                <img [src]="checklistDetalhado.fotos.LATERAL_ESQUERDA" alt="Lateral Esquerda"
                  (click)="expandirFoto(checklistDetalhado.fotos.LATERAL_ESQUERDA)" />
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Pneus (dados agrupados - novo formato) -->
        <ion-card *ngIf="checklistDetalhado.itens?.PNEU_AGRUPADO && checklistDetalhado.itens.PNEU_AGRUPADO.length > 0">
          <ion-card-header>
            <ion-card-title>Pneus</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div *ngFor="let posicao of checklistDetalhado.itens.PNEU_AGRUPADO" style="margin-bottom: 16px; border-bottom: 1px solid #333; padding-bottom: 12px;">
              <h3 style="font-weight: bold; margin-bottom: 8px;">
                <ion-icon name="ellipse" color="primary" style="margin-right: 6px;"></ion-icon>
                {{ posicao.posicao }}
              </h3>
              <p *ngIf="posicao.pressao" style="margin-bottom: 8px;"><strong>Pressão:</strong> {{ posicao.pressao }} PSI</p>
              <ion-list>
                <div *ngFor="let regra of posicao.regras">
                  <ion-item>
                    <ion-label>
                      <h3>{{ regra.sub_item || regra.item }}</h3>
                      <p><ion-badge [color]="getCorStatus(regra.status)">{{ regra.status || 'N/A' }}</ion-badge></p>
                      <p *ngIf="regra.descricao"><em>{{ regra.descricao }}</em></p>
                    </ion-label>
                  </ion-item>
                  <div class="foto-item" *ngIf="regra.foto">
                    <h4>Foto</h4>
                    <img [src]="regra.foto" [alt]="regra.sub_item || regra.item" (click)="expandirFoto(regra.foto)" />
                  </div>
                </div>
              </ion-list>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Pneus (dados legados - formato antigo sem sub_item) -->
        <ion-card *ngIf="!checklistDetalhado.itens?.PNEU_AGRUPADO && checklistDetalhado.itens?.PNEU && checklistDetalhado.itens.PNEU.length > 0">
          <ion-card-header>
            <ion-card-title>Pneus</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <div *ngFor="let item of checklistDetalhado.itens.PNEU">
                <ion-item>
                  <ion-label>
                    <h3>{{ item.item }}</h3>
                    <p><ion-badge [color]="getCorStatus(item.status)">{{ item.status || 'N/A' }}</ion-badge></p>
                    <p *ngIf="item.pressao"><strong>Pressão:</strong> {{ item.pressao }} PSI</p>
                  </ion-label>
                </ion-item>
                <div class="foto-item" *ngIf="item.foto">
                  <h4>Foto do Pneu</h4>
                  <img [src]="item.foto" [alt]="item.item" (click)="expandirFoto(item.foto)" />
                </div>
              </div>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para expansão de foto -->
<ion-modal [isOpen]="mostrarFotoExpandida" (didDismiss)="fecharFotoExpandida()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-title>Foto - Zoom {{ zoomLevel }}x</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="resetZoom()" [disabled]="zoomLevel === 1">
            <ion-icon name="contract-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="zoomOut()" [disabled]="zoomLevel <= 0.5">
            <ion-icon name="remove-circle-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="zoomIn()" [disabled]="zoomLevel >= 5">
            <ion-icon name="add-circle-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="fecharFotoExpandida()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="foto-expandida-content">
      <div class="foto-expandida-container">
        <img [src]="fotoExpandida" alt="Foto Expandida" class="foto-expandida"
          [style.transform]="'scale(' + zoomLevel + ')'" />
      </div>

      <!-- Controles de zoom flutuantes -->
      <div class="zoom-controls">
        <ion-fab-button size="small" color="light" (click)="zoomOut()" [disabled]="zoomLevel <= 0.5">
          <ion-icon name="remove"></ion-icon>
        </ion-fab-button>
        <ion-chip color="light">
          <ion-label>{{ zoomLevel }}x</ion-label>
        </ion-chip>
        <ion-fab-button size="small" color="light" (click)="zoomIn()" [disabled]="zoomLevel >= 5">
          <ion-icon name="add"></ion-icon>
        </ion-fab-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Teste de Foto - Comparação Lado a Lado -->
<ion-modal [isOpen]="!!fotoOriginalTeste" (didDismiss)="fecharFotoTeste()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="tertiary">
        <ion-title>Comparação de Qualidade</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharFotoTeste()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div style="margin-bottom: 16px; text-align: center;">
        <ion-chip color="primary">
          <ion-icon name="information-circle"></ion-icon>
          <ion-label>Toque nas imagens para dar zoom</ion-label>
        </ion-chip>
      </div>

      <!-- Comparação Lado a Lado - Desktop/Tablet -->
      <div class="comparacao-container desktop-view">
        <!-- Foto Original -->
        <div class="foto-comparacao">
          <div class="foto-header">
            <h3>📸 Original (100%)</h3>
            <p>{{ tamanhoOriginalTeste }}</p>
          </div>
          <div class="foto-wrapper" (click)="expandirFoto(fotoOriginalTeste!)">
            <img [src]="fotoOriginalTeste" alt="Foto Original" />
          </div>
        </div>

        <!-- Foto Comprimida -->
        <div class="foto-comparacao">
          <div class="foto-header">
            <h3>🗜️ Comprimida (60%)</h3>
            <p>{{ tamanhoComprimidoTeste }}</p>
          </div>
          <div class="foto-wrapper" (click)="expandirFoto(fotoComprimidaTeste!)">
            <img [src]="fotoComprimidaTeste" alt="Foto Comprimida" />
          </div>
        </div>
      </div>

      <!-- Comparação Empilhada - Mobile -->
      <div class="comparacao-container mobile-view">
        <!-- Foto Original -->
        <div class="foto-comparacao-mobile">
          <div class="foto-header">
            <h3>📸 Original (100%)</h3>
            <p>{{ tamanhoOriginalTeste }}</p>
          </div>
          <div class="foto-wrapper" (click)="expandirFoto(fotoOriginalTeste!)">
            <img [src]="fotoOriginalTeste" alt="Foto Original" />
          </div>
        </div>

        <!-- Foto Comprimida -->
        <div class="foto-comparacao-mobile">
          <div class="foto-header">
            <h3>🗜️ Comprimida (60%)</h3>
            <p>{{ tamanhoComprimidoTeste }}</p>
          </div>
          <div class="foto-wrapper" (click)="expandirFoto(fotoComprimidaTeste!)">
            <img [src]="fotoComprimidaTeste" alt="Foto Comprimida" />
          </div>
        </div>
      </div>

      <!-- Estatísticas -->
      <ion-card color="success">
        <ion-card-content>
          <div style="text-align: center;">
            <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: bold;">{{ reducaoPercentualTeste }}%</h2>
            <p style="margin: 0; font-size: 16px;">de redução no tamanho</p>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Teste de Múltiplas Qualidades -->
<ion-modal [isOpen]="mostrarModalTestes" (didDismiss)="fecharModalTestes()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="tertiary">
        <ion-title>Teste de Qualidade - 10% a 100%</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModalTestes()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <!-- Foto Original -->
      <ion-card color="primary">
        <ion-card-header>
          <ion-card-title>📸 Original (100%)</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="foto-wrapper" (click)="expandirFoto(fotoOriginalTeste!)">
            <img [src]="fotoOriginalTeste" alt="Foto Original" style="width: 100%; border-radius: 8px;" />
          </div>
          <p style="margin-top: 10px; text-align: center; font-weight: bold; font-size: 18px;">
            {{ tamanhoOriginalTeste }}
          </p>
        </ion-card-content>
      </ion-card>

      <!-- Grid de Qualidades -->
      <div class="qualidades-grid">
        <ion-card *ngFor="let teste of testesQualidades" [color]="teste.qualidade === 60 ? 'success' : 'light'">
          <ion-card-header>
            <ion-card-title style="display: flex; align-items: center; justify-content: space-between;">
              <span>{{ teste.qualidade }}%</span>
              <ion-badge [color]="teste.qualidade === 60 ? 'warning' : 'medium'">
                {{ teste.qualidade === 60 ? '⭐ Recomendado' : teste.reducao + '% menor' }}
              </ion-badge>
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="foto-wrapper" (click)="expandirFoto(teste.foto)">
              <img [src]="teste.foto" [alt]="'Qualidade ' + teste.qualidade + '%'"
                style="width: 100%; border-radius: 8px;" />
            </div>
            <p style="margin-top: 10px; text-align: center; font-weight: bold;">
              {{ teste.tamanho }}
            </p>
            <p style="margin: 0; text-align: center; color: var(--ion-color-medium); font-size: 14px;">
              Redução: {{ teste.reducao }}%
            </p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Informação -->
      <ion-card color="warning">
        <ion-card-content>
          <p style="margin: 0; text-align: center;">
            <ion-icon name="information-circle"></ion-icon>
            <strong>60%</strong> é a qualidade recomendada - balanceia tamanho e qualidade visual
          </p>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Detalhes do Checklist Completo -->
<ion-modal [isOpen]="mostrarModalCompleto" (didDismiss)="fecharModalCompleto()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="success">
        <ion-title>Checklist Completo - Detalhes</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModalCompleto()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content *ngIf="checklistCompletoDetalhado">
      <div class="detalhes-container">
        <!-- Informações Básicas -->
        <ion-card class="info-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="information-circle"></ion-icon>
              Informações Básicas
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <ion-icon name="finger-print" color="medium"></ion-icon>
                <div class="info-content">
                  <span class="info-label">ID</span>
                  <span class="info-value">#{{ checklistCompletoDetalhado.id }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="car" color="success"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Placa</span>
                  <span class="info-value">{{ checklistCompletoDetalhado.placa }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="location" color="danger"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Local</span>
                  <span class="info-value">{{ checklistCompletoDetalhado.local || 'Não informado' }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="speedometer" color="warning"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Quilometragem</span>
                  <span class="info-value">{{ checklistCompletoDetalhado.km_inicial }} km</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="water" color="tertiary"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Combustível</span>
                  <span class="info-value">{{ checklistCompletoDetalhado.nivel_combustivel }}</span>
                </div>
              </div>

              <div class="info-item">
                <ion-icon name="calendar" color="success"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Data/Hora</span>
                  <span class="info-value">{{ formatarData(checklistCompletoDetalhado.data_realizacao) }}</span>
                </div>
              </div>

              <div class="info-item" *ngIf="checklistCompletoDetalhado.usuario_nome">
                <ion-icon name="person" color="secondary"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Inspetor</span>
                  <span class="info-value">{{ checklistCompletoDetalhado.usuario_nome }}</span>
                </div>
              </div>
            </div>

            <div class="observacao-section" *ngIf="checklistCompletoDetalhado.observacao_painel">
              <ion-chip color="warning">
                <ion-icon name="chatbox-ellipses"></ion-icon>
                <ion-label>Observação do Painel</ion-label>
              </ion-chip>
              <p class="observacao-text">{{ checklistCompletoDetalhado.observacao_painel }}</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Foto do Painel -->
        <ion-card *ngIf="checklistCompletoDetalhado.foto_painel">
          <ion-card-header>
            <ion-card-title>Foto do Painel</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="foto-item">
              <img [src]="checklistCompletoDetalhado.foto_painel" alt="Painel"
                (click)="expandirFoto(checklistCompletoDetalhado.foto_painel)" />
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Parte 1 - Interna -->
        <ion-card *ngIf="checklistCompletoDetalhado.parte1">
          <ion-card-header>
            <ion-card-title>Parte 1 - Itens Internos</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let key of getObjectKeys(checklistCompletoDetalhado.parte1)">
                <ion-label>
                  <h3>{{ formatarNomeCampo(key) }}</h3>
                  <p>{{ formatarValor(checklistCompletoDetalhado.parte1[key]) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Parte 2 - Equipamentos -->
        <ion-card *ngIf="checklistCompletoDetalhado.parte2">
          <ion-card-header>
            <ion-card-title>Parte 2 - Equipamentos Obrigatórios</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let key of getObjectKeys(checklistCompletoDetalhado.parte2)">
                <ion-label>
                  <h3>{{ formatarNomeCampo(key) }}</h3>
                  <p>{{ formatarValor(checklistCompletoDetalhado.parte2[key]) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Parte 3 - Dianteira -->
        <ion-card *ngIf="checklistCompletoDetalhado.parte3">
          <ion-card-header>
            <ion-card-title>Parte 3 - Externa Dianteira</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let key of getObjectKeys(checklistCompletoDetalhado.parte3)">
                <ion-label>
                  <h3>{{ formatarNomeCampo(key) }}</h3>
                  <p>{{ formatarValor(checklistCompletoDetalhado.parte3[key]) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Parte 4 - Traseira -->
        <ion-card *ngIf="checklistCompletoDetalhado.parte4">
          <ion-card-header>
            <ion-card-title>Parte 4 - Externa Traseira</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let key of getObjectKeys(checklistCompletoDetalhado.parte4)">
                <ion-label>
                  <h3>{{ formatarNomeCampo(key) }}</h3>
                  <p>{{ formatarValor(checklistCompletoDetalhado.parte4[key]) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Parte 5 - Especial -->
        <ion-card *ngIf="checklistCompletoDetalhado.parte5">
          <ion-card-header>
            <ion-card-title>Parte 5 - Ônibus/Caminhões/Carro Tanque</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let key of getObjectKeys(checklistCompletoDetalhado.parte5)">
                <ion-label>
                  <h3>{{ formatarNomeCampo(key) }}</h3>
                  <p>{{ formatarValor(checklistCompletoDetalhado.parte5[key]) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Campos da Inspeção Inicial -->
<ion-modal [isOpen]="mostrarModalCamposInspecao" (didDismiss)="fecharModalCamposInspecao()">
  <ng-template>
    <ion-header class="modal-campos-header">
      <ion-toolbar>
        <div class="modal-header-content">
          <div class="modal-header-icon">
            <ion-icon name="document-text-outline"></ion-icon>
          </div>
          <div class="modal-header-text">
            <ion-title>Campos da Inspeção Inicial</ion-title>
            <p>Configuração base para todos os veículos</p>
          </div>
        </div>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModalCamposInspecao()" class="close-btn">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-campos-content">
      <!-- Botão Adicionar -->
      <div class="add-campo-btn" (click)="abrirModalAdicionarCampoInspecao()">
        <ion-icon name="add-circle"></ion-icon>
        <span>Adicionar Novo Campo</span>
      </div>

      <!-- Loading -->
      <div *ngIf="carregandoCamposInspecao" class="loading-container">
        <ion-spinner name="crescent" color="secondary"></ion-spinner>
        <p>Carregando campos...</p>
      </div>

      <!-- Grid de Cards de Campos -->
      <div *ngIf="!carregandoCamposInspecao && camposInspecao.length > 0" class="campos-grid">
        <div *ngFor="let campo of camposInspecao; let i = index"
             class="campo-card"
             [class.campo-desabilitado]="!campo.habilitado"
             [class.campo-editando]="campoEditandoId === campo.id">
          
          <!-- Modo Visualização -->
          <div *ngIf="campoEditandoId !== campo.id" class="campo-view-mode">
            <div class="campo-card-header">
              <span class="campo-ordem">{{ i + 1 }}</span>
              <div class="campo-status" [class.ativo]="campo.habilitado">
                <ion-icon [name]="campo.habilitado ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              </div>
            </div>

            <div class="campo-card-body">
              <h4 class="campo-label">{{ campo.label }}</h4>
              <div class="campo-info">
                <div class="info-item">
                  <ion-icon name="pricetag-outline"></ion-icon>
                  <span>{{ getTipoCampoAmigavel(campo.tipo_campo) }}</span>
                </div>
                <div class="info-item" *ngIf="campo.obrigatorio">
                  <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                  <span>Obrigatório</span>
                </div>
                <div class="info-item" *ngIf="!campo.obrigatorio">
                  <ion-icon name="checkmark-circle-outline" color="medium"></ion-icon>
                  <span>Opcional</span>
                </div>
                <div class="info-item" *ngIf="campo.tem_foto">
                  <ion-icon name="camera-outline" color="primary"></ion-icon>
                  <span>Com Foto</span>
                </div>
                <div class="info-item" *ngIf="!campo.tem_foto">
                  <ion-icon name="image-outline" color="medium"></ion-icon>
                  <span>Sem Foto</span>
                </div>
              </div>
            </div>

            <div class="campo-card-footer">
              <ion-toggle [checked]="campo.habilitado"
                          (ionChange)="toggleCampoInspecao(campo)"
                          mode="ios"></ion-toggle>
              <div class="campo-actions">
                <button class="action-btn edit" (click)="iniciarEdicaoCampo(campo)">
                  <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="action-btn delete" (click)="removerCampoInspecao(campo)">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Modo Edição -->
          <div *ngIf="campoEditandoId === campo.id && campoEditando" class="campo-edit-mode">
            <div class="campo-edit-header">
              <h4>Editando Campo</h4>
            </div>
            
            <div class="campo-edit-body">
              <div class="edit-field">
                <label>Nome do Campo</label>
                <ion-input 
                  [(ngModel)]="campoEditando.label"
                  placeholder="Ex: Placa do Veículo"
                  class="edit-input">
                </ion-input>
              </div>

              <div class="edit-field">
                <label>Tipo de Campo</label>
                <div class="tipo-campo-options">
                  <button
                    *ngFor="let tipo of tiposCampoDisponiveis"
                    class="tipo-campo-btn"
                    [class.selected]="campoEditando.tipo_campo === tipo.value"
                    (click)="campoEditando.tipo_campo = tipo.value; onTipoCampoChange()">
                    <ion-icon [name]="tipo.icon"></ion-icon>
                    <span>{{ tipo.label }}</span>
                  </button>
                </div>
              </div>

              <!-- Campo de opções (só aparece quando tipo é 'select') -->
              <div class="edit-field" *ngIf="campoEditando.tipo_campo === 'select'">
                <label>Opções de Seleção</label>
                <div class="opcoes-container">
                  <div class="opcao-item" *ngFor="let opcao of getOpcoesArray(); let i = index">
                    <ion-input
                      [value]="opcao"
                      (ionChange)="atualizarOpcao(i, $event)"
                      placeholder="Digite uma opção"
                      class="edit-input opcao-input">
                    </ion-input>
                    <ion-button
                      fill="clear"
                      color="danger"
                      size="small"
                      (click)="removerOpcao(i)">
                      <ion-icon name="trash-outline"></ion-icon>
                    </ion-button>
                  </div>
                  <ion-button
                    fill="outline"
                    size="small"
                    (click)="adicionarOpcao()"
                    class="add-opcao-btn">
                    <ion-icon name="add-outline" slot="start"></ion-icon>
                    Adicionar Opção
                  </ion-button>
                </div>
              </div>

              <div class="edit-field checkbox-field">
                <ion-item lines="none">
                  <ion-label>Campo Obrigatório</ion-label>
                  <ion-toggle 
                    [(ngModel)]="campoEditando.obrigatorio"
                    slot="end">
                  </ion-toggle>
                </ion-item>
              </div>

              <div class="edit-field checkbox-field">
                <ion-item lines="none">
                  <ion-label>Campo tem Foto</ion-label>
                  <ion-toggle 
                    [(ngModel)]="campoEditando.tem_foto"
                    slot="end">
                  </ion-toggle>
                </ion-item>
              </div>
            </div>

            <div class="campo-edit-footer">
              <ion-button 
                fill="outline" 
                color="medium"
                (click)="cancelarEdicaoCampo()">
                Cancelar
              </ion-button>
              <ion-button 
                fill="solid" 
                color="primary"
                (click)="salvarEdicaoCampo()">
                Salvar
              </ion-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensagem vazia -->
      <div *ngIf="!carregandoCamposInspecao && camposInspecao.length === 0" class="empty-state-campos">
        <div class="empty-icon">
          <ion-icon name="documents-outline"></ion-icon>
        </div>
        <h3>Nenhum campo configurado</h3>
        <p>Adicione campos para personalizar a inspeção inicial</p>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>